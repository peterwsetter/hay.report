---
title: "Hay.Report for Jan 5, 2019"
output: ioslides_presentation
---

<!--
Welcome to the Hay Report for the week ending January 5, 2019. Hay dot Report analyzes the hay and forage market across the plains.
-->

## This Week

- Colorado and Kansas still on break
- Highlights from the AMS commentary
- Benchmark Review

<!--
Colorado and Kansas are still on break.
In this episode, 
Highlights from the AMS commentary
and review changes in several benchmark forages.
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(dplyr)
library(tidyr)
library(ggplot2)

load('../data/report_data.rds')

CURRENT_DATE <- as.Date('2019-01-05')
CURRENT_WEEK <- lubridate::week(CURRENT_DATE)

state_lookup <- data.frame(state.name, state.abb)

region_lookup <- read.csv('~/hay.report/data/region_lookup.csv',
                          stringsAsFactors = FALSE)

report_data %>% 
  inner_join(state_lookup,
             by = c('state' = 'state.name')) %>% 
  left_join(region_lookup,
            by = c('state' = 'state',
                   'region' = 'region')) %>%
  filter(between(report_date, CURRENT_DATE - 31, CURRENT_DATE)) ->
  video_data

## Functions

week_ending <- function(DATE) {
  DATE + 7 - lubridate::wday(DATE)
}

graph_benchmark <- function(input_data, input_forage, 
                            input_shape, input_size, input_quality) {
  
  input_data %>%
  filter(forage == input_forage,
         shape == input_shape,
         size == input_size,
         quality == input_quality,
         !is.na(price_low)) %>%
  rowwise() %>% 
  mutate(price_max = max(c(price_low, price_high), na.rm = TRUE),
         report_week_ending = week_ending(report_date)) %>% 
  ungroup() %>% 
  ggplot(aes(x = report_week_ending, y = price_avg, 
             label = paste(region.abb, round(price_avg)),
            ymin = price_low, ymax = price_max
            )
         ) +
  geom_pointrange() +
  ggrepel::geom_text_repel(nudge_x = 1) +
  theme_bw() +
  labs(title = paste(input_forage, input_quality, input_size, input_shape),
       x = 'Week Ending',
        y = 'Price') 
}

benchmark_table <- . %>% 
    filter(!is.na(benchmark)) %>% 
  select(benchmark, report_year, report_week, price_low, price_high) %>% 
  gather(key = price_type, value = price, contains('price')) %>% 
  group_by(benchmark, report_year, report_week) %>% 
  summarize(benchmark_value = median(price, na.rm = TRUE)) %>% 
  group_by(benchmark) %>% 
  arrange(benchmark, report_year, report_week) %>% 
  summarize(current_value = last(benchmark_value) %>% 
              round(),
            one_week_change = ((last(benchmark_value) - first(benchmark_value))/first(benchmark_value)) %>% 
              magrittr::multiply_by(100) %>% 
              round() %>% 
              paste0('%')) %>% 
  knitr::kable(col.names = c('Commodity', 'Current Price', '2 Wk Change'),
               align = 'lrr')
```

## Thank You

- Jack Carson, Oklahoma Dept of AG-USDA Market News, Oklahoma City, OK
- Heath Dewey, USDA-CO Dept of Ag Market News Service, Greeley, CO
- Lana Hutto, USDA Market News Service, Amarillo, TX
- John Kimbrell, USDA Market News Service, Billings, MT
- Ross Kotewa, USDA-SD Dept of Ag Market News Service, Sioux Falls, SD
- Kim Nettleton, Kansas Department of Agriculture, Manhattan, KS
- Thomas Walthers, USDA NE and USDA WY

<!--
Hay dot Report relies on the data and commentary of the USDA Agriculture Marketing Service. We thank them for their work serving farmers and ranchers across the country.
-->

## Benchmarks

- Key hay and forage types
- Multi-state & single state

<!--
Hay dot Report tracks several hay types to provide a broad view of the market. First is a look at alfalfa followed by grass hay. 
-->

## Alfalfa Benchmarks

```{r alfalfa_benchmarks}
video_data %>% 
  filter(forage %in% c('Alfalfa', 'Dehydrated Alfalfa'),
         !is.na(price_low),
         between(report_date, CURRENT_DATE - 28, CURRENT_DATE)) %>% 
  mutate(benchmark = case_when(
    state == 'Kansas' & quality == 'Supreme' & is.na(shape) ~ 'Kansas Supreme Dairy',
    state == 'Texas' & quality == 'Premium/Supreme' & size == 'Large' & shape == 'Squares' ~ 'Texas Premium/Supreme',
    quality == 'Premium' & size == 'Large' & shape == 'Squares' ~ 'Multi-State Premium Large Squares',
    #quality == 'Premium' & size == 'Small' & shape == 'Squares' ~ 'Multi-State Premium Small Squares',
    forage == 'Dehydrated Alfalfa' & quality == '17%' ~ 'Multi-State Dehydrated Pellets 17%',
    TRUE ~ NA_character_
  )) %>% 
  filter(!is.na(benchmark)) %>% 
  benchmark_table() ->
  alfalfa_table

save(alfalfa_table, file = paste0('../data-products/alfalfa-table-', CURRENT_DATE, '.rda'))

alfalfa_table
```

<!--
Prices of Kansas Supreme Dairy Alfalfa and Texas Premium Supreme Alfalfa were steady. 17% dehydrated pellets and premium large squares ticked up in the past week. 
-->

## 

```{r apls, fig.height=4.5}
video_data %>%
  graph_benchmark(input_forage = 'Alfalfa',
                  input_quality = 'Premium',
                  input_size = 'Large',
                  input_shape = 'Squares'
                  )

```

<!--
Breaking down the multi-state alfalfa benchmarks shows
-->

##

```{r apss, fig.height=4.5}
video_data %>%
  graph_benchmark(input_forage = 'Alfalfa',
                  input_quality = 'Premium',
                  input_size = 'Small',
                  input_shape = 'Squares'
                  )

```


## Grass Benchmarks

```{r grass_benchmarks}
report_data %>% 
  filter(forage %in% c('Grass', 'Coastal Bermuda', 'Bluestem'),
         !is.na(price_low),
         between(report_date, CURRENT_DATE - 14, CURRENT_DATE)) %>% 
  mutate(benchmark = case_when(
    quality == 'Premium' & size == 'Small' & shape == 'Squares' ~ 'Multi-State Premium Small Squares',
    quality == 'Good' & size == 'Large' & shape == 'Rounds' ~ 'Multi-State Good Large Rounds',
    state == 'Texas' & forage == 'Coastal Bermuda' & size == 'Large' & shape == 'Rounds' & quality == 'Good/Premium' ~ 'Texas G/P Coastal Bermuda Large Rounds',
    forage == 'Bluestem' & size == 'Large' & shape == 'Squares' ~ 'Kansas Bluestem Large Squares',
    TRUE ~ NA_character_
  )) %>% 
  filter(!is.na(benchmark)) %>% 
  benchmark_table() ->
  grass_table

save(grass_table, file = paste0('../data-products/grass-table-', CURRENT_DATE, '.rda'))

grass_table
```

<!--

-->

## Until Next Week

Visit www.hay.report for archives and resources.

<!--
Thank you for watching. Join Hay dot Report every Saturday for an update on the Plains hay and forage market. In the meantime, visit www.hay.report for archives and resources. 
-->
